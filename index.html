<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KGTK Maluku Utara — Layanan Informasi & Pengaduan (r15)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: .2rem; }
    .row { display: grid; grid-template-columns: 160px 1fr; gap: 8px 12px; align-items: center; margin: 6px 0; }
    .row > label { font-size: 14px; color: #333; }
    input[type=text], input[type=email], input[type=tel], textarea, select {
      width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px;
    }
    textarea { min-height: 90px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 16px 0; }
    .muted { color: #666; font-size: 13px; }
    .actions button { padding: 8px 12px; border-radius: 10px; border: 1px solid #ccc; background: #f8f9fa; cursor: pointer; }
    .actions button.primary { background: #2563eb; color: white; border-color: #2563eb; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .hidden { display: none !important; }
    code.block { display: block; white-space: pre-wrap; background: #f6f8fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; margin-right:6px; }
    .sep { height:1px; background:#eee; margin:10px 0; }
  </style>
</head>
<body>
  <h1>Layanan Informasi & Pengaduan</h1>
  <div class="muted">Kantor Guru dan Tenaga Kependidikan (KGTK) Provinsi Maluku Utara — r15</div>

  <div class="card">
    <div class="row">
      <label for="api_base">API_BASE (URL Web App /exec)</label>
      <input id="api_base" type="text" placeholder="https://script.google.com/macros/s/xxx/exec" />
    </div>
    <div class="actions">
      <button id="btnPing">Tes Koneksi</button>
      <span id="pingOut" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>Jenis</label>
      <div>
        <label><input type="radio" name="jenis" value="pengaduan" checked/> Pengaduan</label>
        &nbsp; &nbsp;
        <label><input type="radio" name="jenis" value="permintaan"/> Permintaan Data</label>
      </div>
    </div>

    <div class="row"><label>Nama</label><input id="nama" type="text" /></div>
    <div class="row"><label>Email</label><input id="email" type="email" /></div>
    <div class="row"><label>Telepon</label><input id="telepon" type="tel" /></div>
    <div class="row"><label>Judul</label><input id="judul" type="text" /></div>

    <!-- Bidang meta umum -->
    <div class="grid-2">
      <div class="row"><label>Kab/Kota</label><input id="kabkota" type="text" placeholder="contoh: Kota Ternate"/></div>
      <div class="row"><label>Peran</label><input id="peran" type="text" placeholder="contoh: Kepala Sekolah"/></div>
      <div class="row"><label>Tipe Laporan</label><input id="tipeLaporan" type="text" placeholder="contoh: Layanan"/></div>
      <div class="row"><label>Layanan</label><input id="layanan" type="text" placeholder="contoh: Pengaduan Aplikasi"/></div>
    </div>

    <!-- Khusus pengaduan -->
    <div id="boxPengaduan">
      <div class="row"><label>Kategori (Pengaduan)</label><input id="kategori" type="text" placeholder="contoh: Pelayanan"/></div>
    </div>

    <!-- Khusus permintaan data -->
    <div id="boxPermintaan" class="hidden">
      <div class="row"><label>Instansi</label><input id="instansi" type="text" placeholder="contoh: Dinas Pendidikan"/></div>
      <div class="row"><label>Jenis Data</label><input id="jenisData" type="text" placeholder="contoh: Data GTK per kab/kota"/></div>
      <div class="row"><label>Tujuan</label><input id="tujuan" type="text" placeholder="contoh: Penyusunan program"/></div>
      <div class="row"><label>Surat Permohonan Resmi</label><input id="surat" type="file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.zip"/></div>
    </div>

    <div class="row"><label>Detail</label><textarea id="detail" placeholder="Uraian utama…"></textarea></div>

    <div class="row"><label>Lampiran (opsional)</label><input id="lampiran" type="file" multiple /></div>

    <div class="actions">
      <button id="btnSubmit" class="primary">Kirim</button>
      <span id="submitOut" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>Nomor Tiket</label><input id="ticket" type="text" placeholder="GTK…" />
    </div>
    <div class="actions">
      <button id="btnStatus">Cek Status</button>
    </div>
    <div id="statusOut"><code class="block"></code></div>
  </div>

  <div class="card">
    <h3>Admin</h3>
    <div class="grid-2">
      <div>
        <div class="row"><label>User</label><input id="admin_user" type="text"/></div>
        <div class="row"><label>Pass</label><input id="admin_pass" type="text"/></div>
        <div class="actions">
          <button id="btnLogin">Login</button>
          <button id="btnLogout">Logout</button>
          <span id="loginOut" class="muted"></span>
        </div>
      </div>
      <div>
        <div class="row"><label>Token</label><input id="token" type="text" readonly/></div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid-2">
      <div>
        <div class="row"><label>Filter Tipe</label>
          <select id="fltType">
            <option value="">(semua)</option>
            <option value="pengaduan">pengaduan</option>
            <option value="permintaan">permintaan</option>
          </select>
        </div>
      </div>
      <div>
        <div class="row"><label>Filter Status</label>
          <select id="fltStatus">
            <option value="">(semua)</option>
            <option value="diterima">diterima</option>
            <option value="diproses">diproses</option>
            <option value="selesai">selesai</option>
          </select>
        </div>
      </div>
    </div>
    <div class="row"><label>Cari</label><input id="fltQ" type="text" placeholder="ticket/nama/email"/></div>
    <div class="actions">
      <button id="btnList">Tampilkan</button>
      <button id="btnListReset">Reset</button>
    </div>
    <div id="listOut"></div>

    <div class="sep"></div>

    <div>
      <div class="row"><label>Tiket Detail</label><input id="dt_ticket" type="text" placeholder="GTK…"/></div>
      <div class="actions">
        <button id="btnDetail">Ambil Detail</button>
      </div>
      <div id="detailOut"><code class="block"></code></div>
    </div>

    <div class="sep"></div>

    <div>
      <h4>Ubah Status</h4>
      <div class="grid-2">
        <div class="row"><label>Tiket</label><input id="up_ticket" type="text" placeholder="GTK…"/></div>
        <div class="row"><label>Status Baru</label>
          <select id="up_status">
            <option value="diterima">diterima</option>
            <option value="diproses">diproses</option>
            <option value="selesai">selesai</option>
          </select>
        </div>
      </div>
      <div class="row"><label>Catatan</label><input id="up_note" type="text" placeholder="wajib diisi"/></div>
      <div class="row"><label>Dokumen (URL opsional)</label><input id="up_doc" type="text" placeholder="https://…"/></div>
      <div class="actions">
        <button id="btnUpdate" class="primary">Simpan Perubahan</button>
        <span id="updateOut" class="muted"></span>
      </div>
    </div>
  </div>

  <script>
    const qs = (s, el=document)=> el.querySelector(s);
    const qsa = (s, el=document)=> [...el.querySelectorAll(s)];

    const API_BASE_INPUT = qs('#api_base');
    const PING_OUT = qs('#pingOut');
    const SUBMIT_OUT = qs('#submitOut');
    const STATUS_OUT = qs('#statusOut code');
    const LOGIN_OUT = qs('#loginOut');
    const TOKEN_INPUT = qs('#token');
    const LIST_OUT = qs('#listOut');
    const DETAIL_OUT = qs('#detailOut code');
    const UPDATE_OUT = qs('#updateOut');

    // Persist settings
    function loadState(){
      API_BASE_INPUT.value = localStorage.getItem('API_BASE') || '';
      TOKEN_INPUT.value = localStorage.getItem('KGTK_TOKEN') || '';
      qs('#admin_user').value = localStorage.getItem('KGTK_USER') || '';
      qs('#admin_pass').value = localStorage.getItem('KGTK_PASS') || '';
    }
    function saveApiBase(){ localStorage.setItem('API_BASE', API_BASE_INPUT.value.trim()); }
    function saveToken(tok){ localStorage.setItem('KGTK_TOKEN', tok||''); TOKEN_INPUT.value = tok||''; }
    function saveCred(){
      localStorage.setItem('KGTK_USER', qs('#admin_user').value);
      localStorage.setItem('KGTK_PASS', qs('#admin_pass').value);
    }

    function api(){ const u = API_BASE_INPUT.value.trim(); if(!u) throw new Error('API_BASE kosong'); return u; }

    async function ping(){
      saveApiBase();
      try{
        const r = await fetch(api() + '?action=ping', { method: 'GET' });
        const j = await r.json();
        PING_OUT.textContent = j.ok ? ('Koneksi OK — ' + (j.build||'')) : (j.error||'gagal');
      }catch(e){ PING_OUT.textContent = 'Gagal: ' + e.message; }
    }

    function asMeta(detail){
      const kabkota = qs('#kabkota').value.trim();
      const peran = qs('#peran').value.trim();
      const tipe = qs('#tipeLaporan').value.trim();
      const layanan = qs('#layanan').value.trim();
      const metas = [];
      if(kabkota) metas.push('[Meta] Kab/Kota: ' + kabkota);
      if(peran) metas.push('[Meta] Peran: ' + peran);
      if(tipe) metas.push('[Meta] Tipe Laporan: ' + tipe);
      if(layanan) metas.push('[Meta] Layanan: ' + layanan);
      return (detail ? detail.trim() : '') + (metas.length ? ('\n\n' + metas.join('\n')) : '');
    }

    function getJenis(){
      const v = qs('input[name=jenis]:checked')?.value || 'pengaduan';
      return v === 'permintaan' ? 'permintaan' : 'pengaduan';
    }

    function toggleJenis(){
      const jenis = getJenis();
      qs('#boxPengaduan').classList.toggle('hidden', jenis !== 'pengaduan');
      qs('#boxPermintaan').classList.toggle('hidden', jenis !== 'permintaan');
    }

    function toBase64(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = ()=>{
          const res = String(fr.result||'');
          const comma = res.indexOf(',');
          const b64 = comma>=0 ? res.slice(comma+1) : res;
          resolve({ name: file.name, type: file.type, base64: b64 });
        };
        fr.onerror = ()=> reject(fr.error||new Error('gagal baca file'));
        fr.readAsDataURL(file);
      });
    }

    async function submitForm(){
      saveApiBase();
      SUBMIT_OUT.textContent = 'Mengirim…';
      const jenis = getJenis();
      const payload = {
        action: 'submit',
        type: jenis,
        nama: qs('#nama').value.trim(),
        email: qs('#email').value.trim(),
        telepon: qs('#telepon').value.trim(),
        judul: qs('#judul').value.trim(),
        detail: asMeta(qs('#detail').value)
      };
      if(jenis === 'pengaduan'){
        payload.kategori = qs('#kategori').value.trim();
      } else {
        payload.instansi = qs('#instansi').value.trim();
        payload.jenisData = qs('#jenisData').value.trim();
        payload.tujuan = qs('#tujuan').value.trim();
      }

      // lampiran
      const files = qsa('#lampiran')[0].files;
      if(files && files.length){
        const arr = [];
        for(const f of files){ arr.push(await toBase64(f)); }
        payload.filesB64 = arr;
      }
      // surat resmi
      const surat = qsa('#surat')[0]?.files?.[0];
      if(jenis === 'permintaan' && surat){
        payload.suratB64 = await toBase64(surat);
      }

      try{
        const r = await fetch(api(), {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if(j.ok){
          SUBMIT_OUT.textContent = 'Berhasil. Nomor tiket: ' + j.ticket;
          qs('#ticket').value = j.ticket;
        } else {
          SUBMIT_OUT.textContent = 'Gagal: ' + (j.error||'unknown');
        }
      }catch(e){
        SUBMIT_OUT.textContent = 'Error: ' + e.message;
      }
    }

    async function cekStatus(){
      saveApiBase();
      const t = qs('#ticket').value.trim();
      if(!t){ STATUS_OUT.textContent = 'Masukkan nomor tiket.'; return; }
      try{
        const r = await fetch(api() + '?action=status&ticket=' + encodeURIComponent(t));
        const j = await r.json();
        STATUS_OUT.textContent = JSON.stringify(j, null, 2);
      }catch(e){
        STATUS_OUT.textContent = 'Error: ' + e.message;
      }
    }

    async function login(){
      saveApiBase(); saveCred();
      LOGIN_OUT.textContent = 'Login…';
      try{
        const r = await fetch(api(), {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action:'admin_login', user: qs('#admin_user').value.trim(), pass: qs('#admin_pass').value.trim() })
        });
        const j = await r.json();
        if(j.ok){ saveToken(j.token); LOGIN_OUT.textContent = 'Login OK'; }
        else { LOGIN_OUT.textContent = 'Gagal: ' + (j.error||'unknown'); }
      }catch(e){
        LOGIN_OUT.textContent = 'Error: ' + e.message;
      }
    }

    function logout(){ saveToken(''); LOGIN_OUT.textContent = 'Logout OK'; }

    async function listAdmin(){
      saveApiBase();
      const tok = TOKEN_INPUT.value.trim();
      if(!tok){ LIST_OUT.innerHTML = '<div class="muted">Belum login.</div>'; return; }
      const p = new URLSearchParams();
      p.set('action','admin_list');
      p.set('token', tok);
      const t = qs('#fltType').value.trim(); if(t) p.set('type', t);
      const s = qs('#fltStatus').value.trim(); if(s) p.set('status', s);
      const q = qs('#fltQ').value.trim(); if(q) p.set('q', q);
      try{
        const r = await fetch(api() + '?' + p.toString());
        const j = await r.json();
        if(j.error){ LIST_OUT.innerHTML = '<div class="muted">Error: '+j.error+'</div>'; return; }
        const items = j.items||[];
        if(!items.length){ LIST_OUT.innerHTML = '<div class="muted">Tidak ada data.</div>'; return; }
        const html = items.map(it => `
          <div class="row" style="grid-template-columns: 100px 1fr 1fr 1fr 120px;">
            <div><span class="pill">${it.type}</span></div>
            <div><strong>${it.ticket}</strong></div>
            <div>${it.nama}</div>
            <div>${it.email}</div>
            <div>${it.date}<br/><small>${it.status}</small></div>
          </div>
        `).join('');
        LIST_OUT.innerHTML = '<div class="sep"></div>' + html;
      }catch(e){
        LIST_OUT.innerHTML = '<div class="muted">Error: '+e.message+'</div>';
      }
    }

    function listReset(){
      qs('#fltType').value = '';
      qs('#fltStatus').value = '';
      qs('#fltQ').value = '';
      LIST_OUT.innerHTML = '';
    }

    async function ambilDetail(){
      saveApiBase();
      const tok = TOKEN_INPUT.value.trim();
      const ticket = qs('#dt_ticket').value.trim();
      if(!tok){ DETAIL_OUT.textContent = 'Belum login.'; return; }
      if(!ticket){ DETAIL_OUT.textContent = 'Isi tiket.'; return; }
      const p = new URLSearchParams();
      p.set('action','admin_detail');
      p.set('token', tok);
      p.set('ticket', ticket);
      try{
        const r = await fetch(api() + '?' + p.toString());
        const j = await r.json();
        DETAIL_OUT.textContent = JSON.stringify(j, null, 2);
        // Prefill untuk Update
        qs('#up_ticket').value = ticket;
      }catch(e){
        DETAIL_OUT.textContent = 'Error: ' + e.message;
      }
    }

    async function updateStatus(){
      saveApiBase();
      UPDATE_OUT.textContent = 'Memperbarui…';
      const tok = TOKEN_INPUT.value.trim();
      if(!tok){ UPDATE_OUT.textContent = 'Belum login.'; return; }
      const payload = {
        action: 'admin_update',
        token: tok,
        ticket: qs('#up_ticket').value.trim(),
        newStatus: qs('#up_status').value.trim(),
        note: qs('#up_note').value.trim(),
        docUrl: qs('#up_doc').value.trim()
      };
      if(!payload.ticket){ UPDATE_OUT.textContent = 'Isi tiket.'; return; }
      if(!payload.note){ UPDATE_OUT.textContent = 'Catatan wajib diisi.'; return; }
      try{
        const r = await fetch(api(), {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        UPDATE_OUT.textContent = j.ok ? 'OK' : ('Error: '+(j.error||'unknown'));
      }catch(e){
        UPDATE_OUT.textContent = 'Error: ' + e.message;
      }
    }

    // listeners
    qs('#btnPing').addEventListener('click', ping);
    qsa('input[name=jenis]').forEach(el => el.addEventListener('change', toggleJenis));
    toggleJenis();

    qs('#btnSubmit').addEventListener('click', submitForm);
    qs('#btnStatus').addEventListener('click', cekStatus);

    qs('#btnLogin').addEventListener('click', login);
    qs('#btnLogout').addEventListener('click', logout);

    qs('#btnList').addEventListener('click', listAdmin);
    qs('#btnListReset').addEventListener('click', listReset);

    qs('#btnDetail').addEventListener('click', ambilDetail);
    qs('#btnUpdate').addEventListener('click', updateStatus);

    loadState();
  </script>
</body>
</html>
