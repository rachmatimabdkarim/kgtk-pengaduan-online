<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Layanan Pengaduan & Permintaan Data — KGTK Maluku Utara (UPLOADS r7)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .card-shadow { box-shadow: 0 4px 6px rgba(0,0,0,0.06); }
    .animate-fade { animation: fadeIn .25s ease-in; }
    @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbwYlNhtkr-O-IJ_lzgJqSLIp3g68-_1D0GQ201L-x-zxXM0J8OccwFqYyW19LL2iq8k/exec"; // GANTI: URL /exec dari deployment Apps Script
    const API_VERSION = "v2025-09-07-r7";
    const withNoCache = (url) => url + (url.includes("?") ? "&" : "?") + "_=" + encodeURIComponent(API_VERSION + "-" + Date.now());

    function fileToBase64(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = () => {
          const res = String(fr.result || "");
          const comma = res.indexOf(",");
          const base64 = comma >= 0 ? res.substring(comma+1) : res;
          resolve({ name: file.name, type: file.type || "application/octet-stream", size: file.size, base64 });
        };
        fr.onerror = () => reject(fr.error || new Error("Gagal baca file"));
        fr.readAsDataURL(file);
      });
    }
    async function collectFilesB64(inputEl){
      const files = Array.from(inputEl.files || []);
      const arr = [];
      for (const f of files) arr.push(await fileToBase64(f));
      return arr;
    }
    async function postJSONNoPreflight(payload){
      const res = await fetch(withNoCache(API_BASE), {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return res.json();
    }
    const spinner = '<svg class="animate-spin inline-block w-4 h-4 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';
    async function withBusy(btn, labelWhile, fn){
      if(!btn) return fn();
      const prev = btn.innerHTML;
      const wasDisabled = btn.disabled;
      btn.disabled = true;
      btn.innerHTML = spinner + (labelWhile || "Memproses...");
      try { return await fn(); }
      finally { btn.disabled = wasDisabled; btn.innerHTML = prev; }
    }
    function toast(msg, ok=true){
      const el = document.createElement("div");
      el.className = "fixed z-50 left-1/2 -translate-x-1/2 top-4 px-4 py-2 rounded-lg text-sm text-white " + (ok?"bg-emerald-600":"bg-red-600");
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transition="opacity .3s"; setTimeout(()=>el.remove(), 300); }, 1800);
    }
  </script>

  <header class="bg-blue-800 text-white">
    <div class="container mx-auto px-4 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg" alt="Kemendikbud" class="w-12 h-12 bg-white rounded-full p-1"/>
        <div>
          <h1 class="text-xl font-bold">Kantor GTK Provinsi Maluku Utara</h1>
          <p class="text-blue-100 text-sm">Layanan Pengaduan & Permintaan Data — unggah berkas ke Drive</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button id="trackBtn" class="btn bg-white text-blue-700 px-4 py-2 rounded-lg font-medium hover:bg-blue-50">Lacak Status</button>
        <button id="adminBtn" class="btn bg-yellow-500 px-4 py-2 rounded-lg font-medium hover:bg-yellow-600">Admin</button>
        <button id="pingBtn" class="btn bg-emerald-600 px-4 py-2 rounded-lg font-medium hover:bg-emerald-700">Tes Koneksi</button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg card-shadow mb-8">
      <div class="flex border-b">
        <button id="pengaduanTab" class="flex-1 py-4 px-6 text-center font-medium border-b-2 border-blue-600 text-blue-700 bg-blue-50">Pengaduan</button>
        <button id="permintaanTab" class="flex-1 py-4 px-6 text-center font-medium text-gray-600 hover:bg-gray-50">Permintaan Data</button>
        <button id="statusTab" class="flex-1 py-4 px-6 text-center font-medium text-gray-600 hover:bg-gray-50">Cek Status</button>
        <button id="adminTab" class="flex-1 py-4 px-6 text-center font-medium text-gray-600 hover:bg-gray-50 hidden">Admin Panel</button>
      </div>

      <div id="pengaduanContent" class="p-6 animate-fade">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Form Pengaduan</h2>
        <form id="pengaduanForm" class="space-y-6">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
              <input id="namaPengadu" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
              <input id="emailPengadu" type="email" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon *</label>
              <input id="teleponPengadu" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Kategori Pengaduan *</label>
              <select id="kategoriPengaduan" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">Pilih Kategori</option>
                <option value="sertifikasi">Sertifikasi Guru</option>
                <option value="tunjangan">Tunjangan Profesi</option>
                <option value="mutasi">Mutasi/Perpindahan</option>
                <option value="promosi">Promosi Jabatan</option>
                <option value="administrasi">Administrasi Kepegawaian</option>
                <option value="lainnya">Lainnya</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Judul Pengaduan *</label>
            <input id="judulPengaduan" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ringkasan singkat pengaduan Anda"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Detail Pengaduan *</label>
            <textarea id="detailPengaduan" required rows="5" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Jelaskan detail pengaduan Anda..."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Berkas Pendukung (unggah, opsional)</label>
            <input id="filesPengaduan" type="file" multiple class="w-full px-4 py-3 border rounded-lg bg-white" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.zip"/>
            <p class="text-xs text-gray-500 mt-1">Saran &lt; 10MB per file.</p>
          </div>
          <button class="btn w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700">Kirim Pengaduan</button>
        </form>
      </div>

      <div id="permintaanContent" class="p-6 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Form Permintaan Data</h2>
        <form id="permintaanForm" class="space-y-6">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
              <input id="namaPemohon" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
              <input id="emailPemohon" type="email" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon *</label>
              <input id="teleponPemohon" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Instansi/Organisasi *</label>
              <input id="instansiPemohon" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Data yang Diminta *</label>
            <select id="jenisData" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Pilih Jenis Data</option>
              <option value="statistik-guru">Statistik Guru</option>
              <option value="data-sekolah">Data Sekolah</option>
              <option value="sertifikasi">Data Sertifikasi</option>
              <option value="tunjangan">Data Tunjangan</option>
              <option value="mutasi">Data Mutasi</option>
              <option value="lainnya">Lainnya</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Penggunaan Data *</label>
            <textarea id="tujuanData" required rows="3" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Detail Permintaan Data *</label>
            <textarea id="detailPermintaan" required rows="4" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Surat Permohonan Resmi (URL publik) *</label>
            <input id="suratUrl" type="url" required class="w-full px-4 py-3 border rounded-lg" placeholder="https://drive.google.com/file/d/..."/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Berkas Pendukung (unggah, opsional)</label>
            <input id="filesPermintaan" type="file" multiple class="w-full px-4 py-3 border rounded-lg bg-white" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.zip"/>
            <p class="text-xs text-gray-500 mt-1">Saran &lt; 10MB per file.</p>
          </div>
          <button class="btn w-full bg-green-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-green-700">Kirim Permintaan Data</button>
        </form>
      </div>

      <div id="statusContent" class="p-6 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Lacak Status Pengajuan</h2>
        <div class="max-w-md mx-auto">
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Tiket</label>
            <div class="flex gap-2">
              <input id="nomorTiket" class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="GTKXXXXXXXXX"/>
              <button id="cekStatusBtn" class="btn bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700">Cek Status</button>
            </div>
          </div>
          <pre id="statusResult" class="hidden bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-auto"></pre>
        </div>
      </div>

      <div id="adminContent" class="p-6 hidden">
        <div id="adminLogin" class="max-w-sm mx-auto">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Login Admin</h2>
          <form id="loginForm" class="space-y-4">
            <input id="adminUser" placeholder="Username" class="w-full px-4 py-3 border rounded-lg" required/>
            <input id="adminPass" type="password" placeholder="Password" class="w-full px-4 py-3 border rounded-lg" required/>
            <button class="btn w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Login</button>
          </form>
          <p class="text-xs text-gray-500 mt-3 text-center">Kredensial diatur di Script Properties.</p>
        </div>

        <div id="adminDash" class="hidden">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Dashboard Admin</h2>
            <div class="flex gap-2">
              <button id="refreshBtn" class="btn bg-blue-600 text-white px-4 py-2 rounded-lg">Refresh</button>
              <button id="logoutBtn" class="btn bg-red-600 text-white px-4 py-2 rounded-lg">Logout</button>
            </div>
          </div>

          <div class="bg-gray-50 rounded-lg p-3 mb-3 grid md:grid-cols-3 gap-2">
            <select id="filterType" class="px-3 py-2 border rounded-lg text-sm">
              <option value="">Semua Jenis</option>
              <option value="pengaduan">Pengaduan</option>
              <option value="permintaan">Permintaan Data</option>
            </select>
            <select id="filterStatus" class="px-3 py-2 border rounded-lg text-sm">
              <option value="">Semua Status</option>
              <option value="diterima">Diterima</option>
              <option value="diproses">Diproses</option>
              <option value="selesai">Selesai</option>
            </select>
            <input id="searchInput" placeholder="Cari nama/email/tiket..." class="px-3 py-2 border rounded-lg text-sm"/>
          </div>

          <div class="bg-white rounded-lg overflow-hidden border">
            <table class="w-full text-sm">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-3 py-2 text-left">Tiket</th>
                  <th class="px-3 py-2 text-left">Jenis</th>
                  <th class="px-3 py-2 text-left">Nama</th>
                  <th class="px-3 py-2 text-left">Email</th>
                  <th class="px-3 py-2 text-left">Tanggal</th>
                  <th class="px-3 py-2 text-left">Status</th>
                  <th class="px-3 py-2 text-left">Aksi</th>
                </tr>
              </thead>
              <tbody id="dataTableBody"></tbody>
            </table>
            <div id="noDataMessage" class="text-center text-gray-500 py-6 hidden">Tidak ada data</div>
          </div>

          <dialog id="detailDialog" class="rounded-lg p-0 w-full max-w-4xl">
            <form method="dialog" class="p-5 space-y-3">
              <h3 class="text-xl font-semibold">Detail Pengajuan</h3>
              <div id="detailBody" class="text-sm text-gray-800 space-y-2"></div>
              <menu class="flex gap-2 justify-end mt-3">
                <button id="detailClose" type="button" class="px-4 py-2 rounded bg-blue-600 text-white">Tutup</button>
              </menu>
            </form>
          </dialog>

          <dialog id="previewDialog" class="rounded-lg p-0 w-full max-w-5xl">
            <form method="dialog" class="p-0">
              <div class="flex items-center justify-between px-4 py-3 border-b">
                <div class="font-semibold" id="pvTitle">Preview</div>
                <button id="pvClose" type="button" class="px-3 py-1 rounded bg-gray-200">Tutup</button>
              </div>
              <div id="pvBody" class="p-0 bg-black/5" style="height: 70vh; display:flex; align-items:center; justify-content:center;">
                <div class="text-gray-600 text-sm px-4 py-2">Menyiapkan pratinjau...</div>
              </div>
            </form>
          </dialog>

          <dialog id="updateDialog" class="rounded-lg p-0 w-full max-w-md">
            <form method="dialog" class="p-4 space-y-3">
              <h3 class="text-lg font-semibold">Update Status</h3>
              <input id="updTicket" type="hidden"/>
              <label class="block text-sm">Status Baru</label>
              <select id="updStatus" class="w-full px-3 py-2 border rounded-lg">
                <option value="diterima">Diterima</option>
                <option value="diproses">Sedang Diproses</option>
                <option value="selesai">Selesai</option>
              </select>
              <label class="block text-sm mt-2">Catatan *</label>
              <textarea id="updNote" rows="3" class="w-full px-3 py-2 border rounded-lg" required></textarea>
              <label class="block text-sm mt-2">Dokumen Tambahan (URL publik, opsional)</label>
              <input id="updDocUrl" class="w-full px-3 py-2 border rounded-lg"/>
              <menu class="flex gap-2 justify-end mt-3">
                <button id="updCancel" type="button" class="px-4 py-2 rounded bg-gray-200">Batal</button>
                <button id="updSubmit" class="btn px-4 py-2 rounded bg-blue-600 text-white">Update</button>
              </menu>
            </form>
          </dialog>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-gray-900 text-white mt-10">
    <div class="container mx-auto px-4 py-6 text-center text-sm text-gray-300">
      © 2025 KGTK Maluku Utara
    </div>
  </footer>

  <script>
    const tabs = {
      pengaduan: { tab: document.getElementById("pengaduanTab"), content: document.getElementById("pengaduanContent") },
      permintaan: { tab: document.getElementById("permintaanTab"), content: document.getElementById("permintaanContent") },
      status: { tab: document.getElementById("statusTab"), content: document.getElementById("statusContent") },
      admin: { tab: document.getElementById("adminTab"), content: document.getElementById("adminContent") },
    };
    function switchTab(key){
      Object.keys(tabs).forEach(k => {
        const {tab, content} = tabs[k];
        if(k===key){ tab.classList.add("border-b-2","border-blue-600","text-blue-700","bg-blue-50"); content.classList.remove("hidden"); }
        else{ tab.classList.remove("border-b-2","border-blue-600","text-blue-700","bg-blue-50"); content.classList.add("hidden"); }
      });
    }
    tabs.pengaduan.tab.onclick = () => switchTab("pengaduan");
    tabs.permintaan.tab.onclick = () => switchTab("permintaan");
    tabs.status.tab.onclick = () => switchTab("status");
    tabs.admin.tab.onclick = () => switchTab("admin");
    document.getElementById("trackBtn").onclick = () => switchTab("status");
    document.getElementById("adminBtn").onclick = () => { document.getElementById("adminTab").classList.remove("hidden"); switchTab("admin"); };

    document.getElementById("pingBtn").addEventListener("click", async (ev)=>{
      const btn = ev.currentTarget;
      await withBusy(btn, "Menghubungkan...", async ()=>{
        try {
          const res = await fetch(withNoCache(API_BASE + "?action=ping"));
          const data = await res.json();
          toast(data && data.ok ? `Koneksi OK. Build: ${data.build}` : "Ping gagal.", !!(data && data.ok));
        } catch (e) {
          toast("Ping gagal: " + e, false);
        }
      });
    });

    function val(id){ return document.getElementById(id).value.trim(); }

    document.getElementById("pengaduanForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const btn = e.submitter;
      await withBusy(btn, "Mengirim...", async ()=>{
        const filesB64 = await collectFilesB64(document.getElementById("filesPengaduan"));
        const payload = { action: "submit", type: "pengaduan", nama: val("namaPengadu"), email: val("emailPengadu"), telepon: val("teleponPengadu"), kategori: val("kategoriPengaduan"), judul: val("judulPengaduan"), detail: val("detailPengaduan"), filesB64 };
        let data;
        try { data = await postJSONNoPreflight(payload); }
        catch(err){ toast("Gagal mengirim ke server.", false); return; }
        if (data.error) { toast(data.error, false); return; }
        toast("Berhasil dikirim. Nomor tiket: " + data.ticket, true);
        document.getElementById("pengaduanForm").reset();
        switchTab("status"); document.getElementById("nomorTiket").value = data.ticket;
      });
    });

    document.getElementById("permintaanForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const btn = e.submitter;
      await withBusy(btn, "Mengirim...", async ()=>{
        const filesB64 = await collectFilesB64(document.getElementById("filesPermintaan"));
        const payload = { action: "submit", type: "permintaan", nama: val("namaPemohon"), email: val("emailPemohon"), telepon: val("teleponPemohon"), instansi: val("instansiPemohon"), jenisData: val("jenisData"), tujuan: val("tujuanData"), detail: val("detailPermintaan"), suratUrl: val("suratUrl"), filesB64 };
        let data;
        try { data = await postJSONNoPreflight(payload); }
        catch(e1){ toast("Gagal mengirim ke server.", false); return; }
        if (data.error) { toast(data.error, false); return; }
        toast("Berhasil dikirim. Nomor tiket: " + data.ticket, true);
        document.getElementById("permintaanForm").reset();
        switchTab("status"); document.getElementById("nomorTiket").value = data.ticket;
      });
    });

    document.getElementById("cekStatusBtn").onclick = async (ev)=>{
      const btn = ev.currentTarget;
      await withBusy(btn, "Mencari...", async ()=>{
        const ticket = document.getElementById("nomorTiket").value.trim();
        if(!ticket) { toast("Masukkan nomor tiket.", false); return; }
        let data;
        try {
          const res = await fetch(withNoCache(API_BASE + "?action=status&ticket=" + encodeURIComponent(ticket)));
          data = await res.json();
        } catch(e){ toast("Gagal menghubungi server.", false); return; }
        if(data.error) { toast(data.error || "Tiket tidak ditemukan.", false); return; }
        const pretty = JSON.stringify(data, null, 2);
        const box = document.getElementById("statusResult");
        box.textContent = pretty; box.classList.remove("hidden");
      });
    };

    let ADMIN_TOKEN = "";
    document.getElementById("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const btn = e.submitter;
      await withBusy(btn, "Masuk...", async ()=>{
        let data;
        try {
          data = await postJSONNoPreflight({ action:"admin_login", user: val("adminUser"), pass: val("adminPass") });
        } catch(e1) { toast("Gagal membaca respons server.", false); return; }
        if(data.error) { toast(data.error || "Login gagal.", false); return; }
        ADMIN_TOKEN = data.token;
        document.getElementById("adminLogin").classList.add("hidden");
        document.getElementById("adminDash").classList.remove("hidden");
        await loadAdmin();
      });
    });
    document.getElementById("logoutBtn").onclick = ()=>{
      ADMIN_TOKEN = ""; document.getElementById("adminDash").classList.add("hidden"); document.getElementById("adminLogin").classList.remove("hidden");
    };
    document.getElementById("refreshBtn").onclick = (ev)=> withBusy(ev.currentTarget, "Muat ulang...", loadAdmin);
    document.getElementById("filterType").onchange = ()=> loadAdmin();
    document.getElementById("filterStatus").onchange = ()=> loadAdmin();
    document.getElementById("searchInput").oninput = ()=>{ loadAdmin(250); };

    let searchDelay;
    async function loadAdmin(delay=0){
      clearTimeout(searchDelay);
      searchDelay = setTimeout(async ()=>{
        const params = new URLSearchParams({ action: "admin_list", token: ADMIN_TOKEN, type: document.getElementById("filterType").value, status: document.getElementById("filterStatus").value, q: document.getElementById("searchInput").value.trim() });
        let data;
        try {
          const res = await fetch(withNoCache(API_BASE + "?" + params.toString()));
          data = await res.json();
        } catch(e1) { toast("Gagal membaca respons server.", false); return; }
        if(data.error) { toast(data.error || "Gagal memuat data.", false); return; }
        renderTable(data.items || []);
      }, delay);
    }

    function renderTable(items){
      const tbody = document.getElementById("dataTableBody");
      const noData = document.getElementById("noDataMessage");
      if(!items.length){ tbody.innerHTML = ""; noData.classList.remove("hidden"); return; }
      noData.classList.add("hidden");
      tbody.innerHTML = items.map(it => {
        const badge = it.status==="selesai" ? "bg-green-100 text-green-800" : it.status==="diproses" ? "bg-blue-100 text-blue-800" : "bg-yellow-100 text-yellow-800";
        return `<tr class="hover:bg-gray-50">
          <td class="px-3 py-2 font-mono text-blue-700">${it.ticket}</td>
          <td class="px-3 py-2">${it.type}</td>
          <td class="px-3 py-2 font-medium">${it.nama}</td>
          <td class="px-3 py-2">${it.email}</td>
          <td class="px-3 py-2">${it.date}</td>
          <td class="px-3 py-2"><span class="px-2 py-1 rounded ${badge} text-xs">${it.status}</span></td>
          <td class="px-3 py-2">
            <div class="flex gap-3">
              <button class="btn text-blue-600 text-xs underline" onclick="openDetail('${it.ticket}', event)">Detail</button>
              <button class="btn text-indigo-600 text-xs underline" onclick="openUpdate('${it.ticket}','${it.status}')">Update</button>
            </div>
          </td>
        </tr>`;
      }).join("");
    }

    const dlgDetail = document.getElementById("detailDialog");
    document.getElementById("detailClose").onclick = () => dlgDetail.close();

    async function openDetail(ticket, ev){
      const btn = ev?.currentTarget;
      await withBusy(btn, "Membuka...", async ()=>{
        document.getElementById("detailBody").innerHTML = '<div class="text-gray-600 text-sm">'+spinner+' Memuat detail...</div>';
        dlgDetail.showModal();
        const params = new URLSearchParams({ action:"admin_detail", token: ADMIN_TOKEN, ticket });
        let data;
        try {
          const res = await fetch(withNoCache(API_BASE + "?" + params.toString()));
          data = await res.json();
        } catch(e){ toast("Gagal memuat detail.", false); return; }
        if(data.error){ toast(data.error, false); return; }
        const files = (data.files||[]).map(f=>{
          const id = f.id || "";
          const mime = (f.mime || "").toLowerCase();
          const usePreview = !!id;
          return `<li class="mb-1 flex items-center gap-2">
            <a class="text-blue-700 underline" href="${f.viewUrl}" target="_blank" rel="noopener">${escapeHtml(f.name || f.id)}</a>
            <span class="text-gray-400 text-xs">(${formatBytes(f.size)})</span>
            ${usePreview?`<button class="btn text-xs px-2 py-1 rounded bg-gray-200 hover:bg-gray-300" onclick="previewFile('${id}','${mime}','${escapeHtml(f.name||"")}')">Preview</button>`:""}
          </li>`;
        }).join("") || "<li class='text-gray-500'>Tidak ada berkas</li>";
        const historyHtml = (data.history||[]).map(h=>`<li class="mb-1"><span class="font-medium">${h.status}</span> — <span class="text-gray-600">${new Date(h.timestamp).toLocaleString("id-ID")}</span><div class="text-gray-700">${escapeHtml(h.note||"")}</div></li>`).join("") || "<li class='text-gray-500'>Belum ada riwayat</li>";
        document.getElementById("detailBody").innerHTML = `
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <div><span class="text-gray-500">Tiket:</span> <span class="font-mono">${data.ticket}</span></div>
              <div><span class="text-gray-500">Jenis:</span> ${data.type}</div>
              <div><span class="text-gray-500">Status:</span> ${data.status}</div>
              <div><span class="text-gray-500">Tanggal:</span> ${new Date(data.timestamp).toLocaleString("id-ID")}</div>
            </div>
            <div>
              <div><span class="text-gray-500">Nama:</span> ${escapeHtml(data.nama||"")}</div>
              <div><span class="text-gray-500">Email:</span> ${escapeHtml(data.email||"")}</div>
              <div><span class="text-gray-500">Telepon:</span> ${escapeHtml(data.telepon||"")}</div>
              ${data.instansi?`<div><span class="text-gray-500">Instansi:</span> ${escapeHtml(data.instansi)}</div>`:""}
            </div>
          </div>
          ${data.kategori?`<div class="mt-2"><span class="text-gray-500">Kategori:</span> ${escapeHtml(data.kategori)}</div>`:""}
          ${data.judul?`<div class="mt-2"><span class="text-gray-500">Judul:</span> ${escapeHtml(data.judul)}</div>`:""}
          <div class="mt-2">
            <div class="text-gray-500">Detail:</div>
            <pre class="bg-gray-50 border rounded p-2 whitespace-pre-wrap">${escapeHtml(data.detail||"")}</pre>
          </div>
          ${data.jenisData?`<div class="mt-2"><span class="text-gray-500">Jenis Data:</span> ${escapeHtml(data.jenisData)}</div>`:""}
          ${data.tujuan?`<div class="mt-2"><span class="text-gray-500">Tujuan:</span> ${escapeHtml(data.tujuan)}</div>`:""}
          ${data.suratUrl?`<div class="mt-2"><span class="text-gray-500">Surat Resmi:</span> <a class="text-blue-700 underline" href="${data.suratUrl}" target="_blank" rel="noopener">${data.suratUrl}</a></div>`:""}
          <div class="mt-4">
            <div class="font-semibold mb-1">Berkas Terunggah</div>
            <ul class="list-disc pl-5">${files}</ul>
            ${data.folderUrl?`<div class="mt-2"><a class="text-indigo-700 underline" target="_blank" rel="noopener" href="${data.folderUrl}">Buka Folder Tiket di Drive</a></div>`:""}
          </div>
          <div class="mt-4">
            <div class="font-semibold mb-1">Riwayat Status</div>
            <ul class="list-disc pl-5">${historyHtml}</ul>
          </div>
        `;
      });
    }

    const dlgPreview = document.getElementById("previewDialog");
    document.getElementById("pvClose").onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); dlgPreview.close(); };
    dlgPreview.addEventListener("cancel", (e)=>{ e.preventDefault(); dlgPreview.close(); });

    function stext(t){ return String(t||"").replace(/[<>]/g,""); }

    window.previewFile = (id, mime, name) => {
      const pvBody = document.getElementById("pvBody");
      const pvTitle = document.getElementById("pvTitle");
      pvBody.innerHTML = '<div class="text-gray-600 text-sm px-4 py-2">'+spinner+' Memuat pratinjau...</div>';
      pvTitle.textContent = stext(name || "Preview");
      const iframe = document.createElement("iframe");
      iframe.src = "https://drive.google.com/file/d/" + encodeURIComponent(id) + "/preview";
      iframe.title = name || "preview";
      iframe.style.width = "100%";
      iframe.style.height = "70vh";
      iframe.setAttribute("allow", "autoplay");
      iframe.setAttribute("referrerpolicy", "no-referrer");
      iframe.onload = ()=>{ pvBody.innerHTML=""; pvBody.appendChild(iframe); };
      iframe.onerror = ()=>{
        pvBody.innerHTML = '<div class="p-4 text-sm text-red-700">Pratinjau gagal dimuat. <a class="underline text-blue-700" target="_blank" rel="noopener" href="https://drive.google.com/file/d/'+encodeURIComponent(id)+'/view">Buka di tab baru</a></div>';
      };
      dlgPreview.showModal();
      setTimeout(()=>{ pvBody.innerHTML=""; pvBody.appendChild(iframe); }, 50);
    };

    function formatBytes(b){
      if(!b && b!==0) return "-";
      const u=["B","KB","MB","GB"]; let i=0; let n=b;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return n.toFixed(1)+" "+u[i];
    }
    function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    const dlg = document.getElementById("updateDialog");
    document.getElementById("updCancel").onclick = ()=> dlg.close();
    document.getElementById("updSubmit").onclick = async (e)=>{
      e.preventDefault();
      const btn = e.currentTarget;
      await withBusy(btn, "Menyimpan...", async ()=>{
        const payload = { action: "admin_update", token: ADMIN_TOKEN, ticket: document.getElementById("updTicket").value, newStatus: document.getElementById("updStatus").value, note: document.getElementById("updNote").value.trim(), docUrl: document.getElementById("updDocUrl").value.trim() };
        let data;
        try {
          data = await postJSONNoPreflight(payload);
        } catch(e1) { toast("Gagal membaca respons server.", false); return; }
        if(data.error) { toast(data.error || "Gagal update.", false); return; }
        dlg.close(); loadAdmin();
        toast("Status diperbarui & email terkirim.", true);
      });
    };

    window.openUpdate = (ticket, status)=>{
      document.getElementById("updTicket").value = ticket;
      document.getElementById("updStatus").value = status;
      document.getElementById("updNote").value = "";
      document.getElementById("updDocUrl").value = "";
      dlg.showModal();
    };
  </script>
</body>
</html>
