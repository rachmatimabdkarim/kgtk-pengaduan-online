<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Layanan Pengaduan & Permintaan Data — KGTK Maluku Utara (UPLOADS r4)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .card-shadow { box-shadow: 0 4px 6px rgba(0,0,0,0.06); }
    .animate-fade { animation: fadeIn .25s ease-in; }
    @keyframes fadeIn { from {opacity:0} to {opacity:1} }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbzc-M3xv4eqc7qjTEKkt_Kz-K746WX-Kc23zWP9P0p7ooxgTNmel3mWkgT-WUEWKLpL/exec"; // ganti dengan URL /exec
    const API_VERSION = "v2025-09-07-r4-b64";
    const withNoCache = (url) => url + (url.includes("?") ? "&" : "?") + "_=" + encodeURIComponent(API_VERSION + "-" + Date.now());

    // Helper: ubah File -> base64 (tanpa prefix data:)
    function fileToBase64(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = () => {
          const res = String(fr.result || "");
          const comma = res.indexOf(",");
          const base64 = comma >= 0 ? res.substring(comma+1) : res;
          resolve({ name: file.name, type: file.type || "application/octet-stream", size: file.size, base64 });
        };
        fr.onerror = () => reject(fr.error || new Error("Gagal baca file"));
        fr.readAsDataURL(file);
      });
    }
    async function collectFilesB64(inputEl){
      const files = Array.from(inputEl.files || []);
      const arr = [];
      for (const f of files) arr.push(await fileToBase64(f));
      return arr;
    }
    async function postJSON(payload){
      const res = await fetch(withNoCache(API_BASE), {
        method:"POST",
        headers:{ "Content-Type":"application/json;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return res.json();
    }
  </script>

  <header class="bg-blue-800 text-white">
    <div class="container mx-auto px-4 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg" alt="Kemendikbud" class="w-12 h-12 bg-white rounded-full p-1"/>
        <div>
          <h1 class="text-xl font-bold">Kantor GTK Provinsi Maluku Utara</h1>
          <p class="text-blue-100 text-sm">Layanan Pengaduan & Permintaan Data — unggah berkas ke Drive</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button id="trackBtn" class="bg-white text-blue-700 px-4 py-2 rounded-lg font-medium hover:bg-blue-50">Lacak Status</button>
        <button id="adminBtn" class="bg-yellow-500 px-4 py-2 rounded-lg font-medium hover:bg-yellow-600">Admin</button>
        <button id="pingBtn" class="bg-emerald-600 px-4 py-2 rounded-lg font-medium hover:bg-emerald-700">Tes Koneksi</button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg card-shadow mb-8">
      <div class="flex border-b">
        <button id="pengaduanTab" class="flex-1 py-4 px-6 text-center font-medium border-b-2 border-blue-600 text-blue-700 bg-blue-50">Pengaduan</button>
        <button id="permintaanTab" class="flex-1 py-4 px-6 text-center font-medium text-gray-600 hover:bg-gray-50">Permintaan Data</button>
        <button id="statusTab" class="flex-1 py-4 px-6 text-center font-medium text-gray-600 hover:bg-gray-50">Cek Status</button>
        <button id="adminTab" class="flex-1 py-4 px-6 text-center font-medium text-gray-600 hover:bg-gray-50 hidden">Admin Panel</button>
      </div>

      <!-- Pengaduan -->
      <div id="pengaduanContent" class="p-6 animate-fade">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Form Pengaduan</h2>
        <form id="pengaduanForm" class="space-y-6">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
              <input id="namaPengadu" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
              <input id="emailPengadu" type="email" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon *</label>
              <input id="teleponPengadu" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Kategori Pengaduan *</label>
              <select id="kategoriPengaduan" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">Pilih Kategori</option>
                <option value="sertifikasi">Sertifikasi Guru</option>
                <option value="tunjangan">Tunjangan Profesi</option>
                <option value="mutasi">Mutasi/Perpindahan</option>
                <option value="promosi">Promosi Jabatan</option>
                <option value="administrasi">Administrasi Kepegawaian</option>
                <option value="lainnya">Lainnya</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Judul Pengaduan *</label>
            <input id="judulPengaduan" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ringkasan singkat pengaduan Anda"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Detail Pengaduan *</label>
            <textarea id="detailPengaduan" required rows="5" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Jelaskan detail pengaduan Anda..."></textarea>
          </div>

          <!-- FILE UPLOAD -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Berkas Pendukung (unggah, opsional)</label>
            <input id="filesPengaduan" type="file" multiple class="w-full px-4 py-3 border rounded-lg bg-white" 
                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.zip"/>
            <p class="text-xs text-gray-500 mt-1">Saran &lt; 10MB per file.</p>
          </div>

          <button class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700">Kirim Pengaduan</button>
        </form>
      </div>

      <!-- Permintaan Data -->
      <div id="permintaanContent" class="p-6 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Form Permintaan Data</h2>
        <form id="permintaanForm" class="space-y-6">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
              <input id="namaPemohon" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
              <input id="emailPemohon" type="email" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon *</label>
              <input id="teleponPemohon" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Instansi/Organisasi *</label>
              <input id="instansiPemohon" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Data yang Diminta *</label>
            <select id="jenisData" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Pilih Jenis Data</option>
              <option value="statistik-guru">Statistik Guru</option>
              <option value="data-sekolah">Data Sekolah</option>
              <option value="sertifikasi">Data Sertifikasi</option>
              <option value="tunjangan">Data Tunjangan</option>
              <option value="mutasi">Data Mutasi</option>
              <option value="lainnya">Lainnya</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Penggunaan Data *</label>
            <textarea id="tujuanData" required rows="3" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Detail Permintaan Data *</label>
            <textarea id="detailPermintaan" required rows="4" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Surat Permohonan Resmi (URL publik) *</label>
            <input id="suratUrl" type="url" required class="w-full px-4 py-3 border rounded-lg" placeholder="https://drive.google.com/file/d/..."/>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Berkas Pendukung (unggah, opsional)</label>
            <input id="filesPermintaan" type="file" multiple class="w-full px-4 py-3 border rounded-lg bg-white" 
                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.zip"/>
            <p class="text-xs text-gray-500 mt-1">Saran &lt; 10MB per file.</p>
          </div>

          <button class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-green-700">Kirim Permintaan Data</button>
        </form>
      </div>

      <!-- Cek Status -->
      <div id="statusContent" class="p-6 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Lacak Status Pengajuan</h2>
        <div class="max-w-md mx-auto">
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Tiket</label>
            <div class="flex gap-2">
              <input id="nomorTiket" class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="GTKXXXXXXXXX"/>
              <button id="cekStatusBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700">Cek Status</button>
            </div>
          </div>
          <pre id="statusResult" class="hidden bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-auto"></pre>
        </div>
      </div>

      <!-- Admin -->
      <div id="adminContent" class="p-6 hidden">
        <div id="adminLogin" class="max-w-sm mx-auto">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Login Admin</h2>
          <form id="loginForm" class="space-y-4">
            <input id="adminUser" placeholder="Username" class="w-full px-4 py-3 border rounded-lg" required/>
            <input id="adminPass" type="password" placeholder="Password" class="w-full px-4 py-3 border rounded-lg" required/>
            <button class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Login</button>
          </form>
          <p class="text-xs text-gray-500 mt-3 text-center">Kredensial diatur di Script Properties.</p>
        </div>

        <div id="adminDash" class="hidden">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Dashboard Admin</h2>
            <div class="flex gap-2">
              <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Refresh</button>
              <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Logout</button>
            </div>
          </div>

          <div class="bg-gray-50 rounded-lg p-3 mb-3 grid md:grid-cols-3 gap-2">
            <select id="filterType" class="px-3 py-2 border rounded-lg text-sm">
              <option value="">Semua Jenis</option>
              <option value="pengaduan">Pengaduan</option>
              <option value="permintaan">Permintaan Data</option>
            </select>
            <select id="filterStatus" class="px-3 py-2 border rounded-lg text-sm">
              <option value="">Semua Status</option>
              <option value="diterima">Diterima</option>
              <option value="diproses">Diproses</option>
              <option value="selesai">Selesai</option>
            </select>
            <input id="searchInput" placeholder="Cari nama/email/tiket..." class="px-3 py-2 border rounded-lg text-sm"/>
          </div>

          <div class="bg-white rounded-lg overflow-hidden border">
            <table class="w-full text-sm">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-3 py-2 text-left">Tiket</th>
                  <th class="px-3 py-2 text-left">Jenis</th>
                  <th class="px-3 py-2 text-left">Nama</th>
                  <th class="px-3 py-2 text-left">Email</th>
                  <th class="px-3 py-2 text-left">Tanggal</th>
                  <th class="px-3 py-2 text-left">Status</th>
                  <th class="px-3 py-2 text-left">Aksi</th>
                </tr>
              </thead>
              <tbody id="dataTableBody"></tbody>
            </table>
            <div id="noDataMessage" class="text-center text-gray-500 py-6 hidden">Tidak ada data</div>
          </div>

          <dialog id="updateDialog" class="rounded-lg p-0 w-full max-w-md">
            <form method="dialog" class="p-4 space-y-3">
              <h3 class="text-lg font-semibold">Update Status</h3>
              <input id="updTicket" type="hidden"/>
              <label class="block text-sm">Status Baru</label>
              <select id="updStatus" class="w-full px-3 py-2 border rounded-lg">
                <option value="diterima">Diterima</option>
                <option value="diproses">Sedang Diproses</option>
                <option value="selesai">Selesai</option>
              </select>
              <label class="block text-sm mt-2">Catatan *</label>
              <textarea id="updNote" rows="3" class="w-full px-3 py-2 border rounded-lg" required></textarea>
              <label class="block text-sm mt-2">Dokumen Tambahan (URL publik, opsional)</label>
              <input id="updDocUrl" class="w-full px-3 py-2 border rounded-lg"/>
              <menu class="flex gap-2 justify-end mt-3">
                <button id="updCancel" class="px-4 py-2 rounded bg-gray-200">Batal</button>
                <button id="updSubmit" class="px-4 py-2 rounded bg-blue-600 text-white">Update</button>
              </menu>
            </form>
          </dialog>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-gray-900 text-white mt-10">
    <div class="container mx-auto px-4 py-6 text-center text-sm text-gray-300">
      © 2025 KGTK Maluku Utara
    </div>
  </footer>

  <script>
    // Tabs
    const tabs = {
      pengaduan: { tab: document.getElementById("pengaduanTab"), content: document.getElementById("pengaduanContent") },
      permintaan: { tab: document.getElementById("permintaanTab"), content: document.getElementById("permintaanContent") },
      status: { tab: document.getElementById("statusTab"), content: document.getElementById("statusContent") },
      admin: { tab: document.getElementById("adminTab"), content: document.getElementById("adminContent") },
    };
    function switchTab(key){
      Object.keys(tabs).forEach(k => {
        const {tab, content} = tabs[k];
        if(k===key){ tab.classList.add("border-b-2","border-blue-600","text-blue-700","bg-blue-50"); content.classList.remove("hidden"); }
        else{ tab.classList.remove("border-b-2","border-blue-600","text-blue-700","bg-blue-50"); content.classList.add("hidden"); }
      });
    }
    tabs.pengaduan.tab.onclick = () => switchTab("pengaduan");
    tabs.permintaan.tab.onclick = () => switchTab("permintaan");
    tabs.status.tab.onclick = () => switchTab("status");
    tabs.admin.tab.onclick = () => switchTab("admin");
    document.getElementById("trackBtn").onclick = () => switchTab("status");
    document.getElementById("adminBtn").onclick = () => { document.getElementById("adminTab").classList.remove("hidden"); switchTab("admin"); };

    // Ping
    document.getElementById("pingBtn").addEventListener("click", async ()=>{
      try {
        const data = await postJSON({ action:"ping" });
        alert(data && data.ok ? `Koneksi OK. Build: ${data.build}` : "Ping gagal.");
      } catch (e) {
        alert("Ping gagal: " + e);
      }
    });

    function val(id){ return document.getElementById(id).value.trim(); }

    // Submit Pengaduan (JSON + base64 files)
    document.getElementById("pengaduanForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const filesB64 = await collectFilesB64(document.getElementById("filesPengaduan"));
      const payload = {
        action: "submit",
        type: "pengaduan",
        nama: val("namaPengadu"),
        email: val("emailPengadu"),
        telepon: val("teleponPengadu"),
        kategori: val("kategoriPengaduan"),
        judul: val("judulPengaduan"),
        detail: val("detailPengaduan"),
        filesB64
      };
      let data;
      try { data = await postJSON(payload); }
      catch(err){ alert("Gagal mengirim ke server."); return; }
      if (data.error) { alert(data.error); return; }
      alert(`Berhasil! Nomor tiket: ${data.ticket}${typeof data.savedFiles==="number" ? `\nFile tersimpan: ${data.savedFiles}` : ""}`);
      switchTab("status"); document.getElementById("nomorTiket").value = data.ticket;
    });

    // Submit Permintaan Data (JSON + base64 files)
    document.getElementById("permintaanForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const filesB64 = await collectFilesB64(document.getElementById("filesPermintaan"));
      const payload = {
        action: "submit",
        type: "permintaan",
        nama: val("namaPemohon"),
        email: val("emailPemohon"),
        telepon: val("teleponPemohon"),
        instansi: val("instansiPemohon"),
        jenisData: val("jenisData"),
        tujuan: val("tujuanData"),
        detail: val("detailPermintaan"),
        suratUrl: val("suratUrl"),
        filesB64
      };
      let data;
      try { data = await postJSON(payload); }
      catch(e1){ alert("Gagal mengirim ke server."); return; }
      if (data.error) { alert(data.error); return; }
      alert(`Berhasil! Nomor tiket: ${data.ticket}${typeof data.savedFiles==="number" ? `\nFile tersimpan: ${data.savedFiles}` : ""}`);
      switchTab("status"); document.getElementById("nomorTiket").value = data.ticket;
    });

    // Cek Status
    document.getElementById("cekStatusBtn").onclick = async ()=>{
      const ticket = document.getElementById("nomorTiket").value.trim();
      if(!ticket) return alert("Masukkan nomor tiket.");
      let data;
      try {
        const res = await fetch(withNoCache(API_BASE + "?action=status&ticket=" + encodeURIComponent(ticket)));
        data = await res.json();
      } catch(e){ alert("Gagal menghubungi server."); return; }
      if(data.error) { alert(data.error || "Tiket tidak ditemukan."); return; }
      const pretty = JSON.stringify(data, null, 2);
      const box = document.getElementById("statusResult");
      box.textContent = pretty; box.classList.remove("hidden");
    };

    // Admin
    let ADMIN_TOKEN = "";
    document.getElementById("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      let data;
      try {
        data = await postJSON({ action:"admin_login", user: val("adminUser"), pass: val("adminPass") });
      } catch(e1) { alert("Gagal membaca respons server."); return; }
      if(data.error) { alert(data.error || "Login gagal."); return; }
      ADMIN_TOKEN = data.token;
      document.getElementById("adminLogin").classList.add("hidden");
      document.getElementById("adminDash").classList.remove("hidden");
      loadAdmin();
    });
    document.getElementById("logoutBtn").onclick = ()=>{
      ADMIN_TOKEN = ""; document.getElementById("adminDash").classList.add("hidden"); document.getElementById("adminLogin").classList.remove("hidden");
    };
    document.getElementById("refreshBtn").onclick = loadAdmin;
    document.getElementById("filterType").onchange = loadAdmin;
    document.getElementById("filterStatus").onchange = loadAdmin;
    document.getElementById("searchInput").oninput = ()=>{ loadAdmin(250); };

    let searchDelay;
    async function loadAdmin(delay=0){
      clearTimeout(searchDelay);
      searchDelay = setTimeout(async ()=>{
        const params = new URLSearchParams({
          action: "admin_list",
          token: ADMIN_TOKEN,
          type: document.getElementById("filterType").value,
          status: document.getElementById("filterStatus").value,
          q: document.getElementById("searchInput").value.trim(),
        });
        let data;
        try {
          const res = await fetch(withNoCache(API_BASE + "?" + params.toString()));
          data = await res.json();
        } catch(e1) { alert("Gagal membaca respons server."); return; }
        if(data.error) { alert(data.error || "Gagal memuat data."); return; }
        renderTable(data.items || []);
      }, delay);
    }

    function renderTable(items){
      const tbody = document.getElementById("dataTableBody");
      const noData = document.getElementById("noDataMessage");
      if(!items.length){ tbody.innerHTML = ""; noData.classList.remove("hidden"); return; }
      noData.classList.add("hidden");
      tbody.innerHTML = items.map(it => {
        const badge = it.status==="selesai" ? "bg-green-100 text-green-800" :
                      it.status==="diproses" ? "bg-blue-100 text-blue-800" : "bg-yellow-100 text-yellow-800";
        return `<tr class="hover:bg-gray-50">
          <td class="px-3 py-2 font-mono text-blue-700">${it.ticket}</td>
          <td class="px-3 py-2">${it.type}</td>
          <td class="px-3 py-2 font-medium">${it.nama}</td>
          <td class="px-3 py-2">${it.email}</td>
          <td class="px-3 py-2">${it.date}</td>
          <td class="px-3 py-2"><span class="px-2 py-1 rounded ${badge} text-xs">${it.status}</span></td>
          <td class="px-3 py-2"><button class="text-blue-600 text-xs underline" onclick="openUpdate('${it.ticket}','${it.status}')">Update</button></td>
        </tr>`;
      }).join("");
    }

    const dlg = document.getElementById("updateDialog");
    document.getElementById("updCancel").onclick = ()=> dlg.close();
    document.getElementById("updSubmit").onclick = async (e)=>{
      e.preventDefault();
      const payload = {
        action: "admin_update",
        token: ADMIN_TOKEN,
        ticket: document.getElementById("updTicket").value,
        newStatus: document.getElementById("updStatus").value,
        note: document.getElementById("updNote").value.trim(),
        docUrl: document.getElementById("updDocUrl").value.trim(),
      };
      let data;
      try {
        const res = await fetch(withNoCache(API_BASE), { method:"POST", headers:{ "Content-Type":"application/json;charset=utf-8" }, body: JSON.stringify(payload) });
        data = await res.json();
      } catch(e1) { alert("Gagal membaca respons server."); return; }
      if(data.error) { alert(data.error || "Gagal update."); return; }
      dlg.close(); loadAdmin();
      alert("Status diperbarui & email terkirim.");
    };

    window.openUpdate = (ticket, status)=>{
      document.getElementById("updTicket").value = ticket;
      document.getElementById("updStatus").value = status;
      document.getElementById("updNote").value = "";
      document.getElementById("updDocUrl").value = "";
      dlg.showModal();
    };
  </script>
</body>
</html>
